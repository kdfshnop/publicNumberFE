/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：有房有客微信CDN框架
 2. 页面名称：citypicker (jQuery插件 - 城市选择)
 3. 作者：zhaohuagang@lifang.com
 4. 实例：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(function($) {
    $.fn.citypicker = function(options) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        将每个citypicker加上对应的配置属性
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var opts = $.extend({}, $.fn.citypicker.defaults, options) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        将每个citypicker加上对应的配置属性
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $.fn.citypicker.addEventListeners() ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
         执行事件添加后返回
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        return this.each(function() {
            var handler = this ;
           $(this).click(function(){
               $.fn.citypicker.open() ;
           }) ;
           $(".city-picker>.city>li").off("click").click(function() {
                var $selectedProvince = $(".city-picker>.province>li.on") ;
                $(handler).find(opts.resultLabelContainerSelector).text($selectedProvince.text() + " " + $(this).text()) ;
                $(handler).attr( opts.resultValueAttr , $selectedProvince.attr("data-id") + "," + $(this).attr("data-id")) ;
                opts.callback($(this).attr("data-id")) ;
                $.fn.citypicker.close() ;
            }) ;
            $.fn.citypicker.init( handler , opts ) ;
        }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    添加事件监听
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.citypicker.addEventListeners = function() {
        $(".city-picker-mask").off("click").click(function() {
            $.fn.citypicker.close() ;
        }) ;
        $(".city-picker>.province>li").off("click").click(function() {
            $(".city-picker>.province>li").removeClass("on") ;
            $(this).addClass("on") ;
            $(".city-picker>.city").hide(100) ;
            $("#cities" + $(this).attr("data-id")).show(100) ;
        }) ;        
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    初始化，根据初始值来决定状态
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.citypicker.init = function( handler , opts ) {
        var initLabel = $(handler).find(opts.resultLabelContainerSelector).text() ;
        var initValue = $(handler).attr(opts.resultValueAttr) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        如果没有初始值就显示第一个
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var selectedProvinceIndex = 0 ;
        if( initValue) {
            var valArray = initValue.split(",") ;
            var selectedProvinceId = valArray[0] ;
            $(".city-picker>.province>li").each(function( index , province ){
                if($(province).attr("data-id") == selectedProvinceId) selectedProvinceIndex = index ;
            }) ;
            $("#cities" + selectedProvinceId + ">li").each(function( index , city ){
                if($(city).attr("data-id") == valArray[1]) $(city).addClass("on") ;
            }) ;
        }
        $(".city-picker>.province>li").eq(selectedProvinceIndex).trigger("click") ;        
        //$(".city-picker>.province").scrollTop($(".city-picker>.province>li").eq(selectedProvinceIndex).offset().top) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    打开城市选择器
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.citypicker.open = function() {
        $(document.body).css({ "overflow" : "hidden" }) ;
        $(".city-picker-mask,.city-picker").show(100) ;        
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
   关闭城市选择器
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.citypicker.close = function() {
        $(document.body).css({ "overflow" : "auto" }) ;
        $(".city-picker-mask,.city-picker").hide(100) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    citypicker默认配置
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.citypicker.defaults = {        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        选择好的城市label以后往节点下的什么选择器表达的容器下写入
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "resultLabelContainerSelector" : "dd" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        选择好的城市value往节点的什么属性下写入
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "resultValueAttr" : "data-value" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        选择好的城市的回调
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "callback" : $.noop
    } ;
})(jQuery) ;