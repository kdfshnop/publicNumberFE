/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：有房有客微信CDN框架
 2. 页面名称：townpicker (jQuery插件 - 板块选择)
 3. 作者：zhaohuagang@lifang.com
 4. 实例：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(function($) {
    $.fn.townpicker = function(options) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        将每个townpicker加上对应的配置属性
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var opts = $.extend({}, $.fn.townpicker.defaults, options) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        点击遮罩区域关闭板块选择器
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
         $(".town-picker-mask").off("click").click(function() {
            $.fn.townpicker.close() ;
        }) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        点击重置按钮
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $(".town-picker>.operate>.reset>.btn").off("click").click(function(){
            $.fn.townpicker.close() ;
            $.fn.townpicker.reset() ;
            $("#townSelector").data("value", "").find("dd").text(""); 
        }) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
         执行事件添加后返回
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        return this.each(function() {
            var handler = this ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            点击确认按钮
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".town-picker>.operate>.confirm>.btn").off("click").click(function(){
               $.fn.townpicker.confirm( handler , opts ) ;
           }) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            点击句柄弹出板块选择器
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
           $(this).click(function(){
               $.fn.townpicker.open() ;
               $.fn.townpicker.init( handler , opts ) ;               
           }) ;              
        }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    事件绑定
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.townpicker.addEventListeners = function() {
           /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            区域选项点击
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".town-picker>.district>li").off("click").click(function(){
                $(".town-picker>.district>li").removeClass("on") ;
                $(this).addClass("on") ;
                $(".town-picker>.town").hide() ;
                $("#town" + $(this).attr("data-id")).show(100) ;
            }) ;
           /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
           板块选项点击
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".town-picker>.town>li").off("click").click(function(){
                $(this).toggleClass("on") ;
                if($(this).hasClass("on")) $(this).find(".iconfont").removeClass("icon-teseweixuan").addClass("icon-teseyixuan") ;
                else $(this).find(".iconfont").removeClass("icon-teseyixuan").addClass("icon-teseweixuan") ;
            }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    打开板块选择器
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.townpicker.open = function() {
        $(document.body).css({ "overflow" : "hidden" }) ;
        $(".town-picker-mask,.town-picker").show(100) ;        
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
   关闭板块选择器
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.townpicker.close = function() {
        $(document.body).css({ "overflow" : "auto" }) ;
        $(".town-picker-mask,.town-picker").hide(100) ;
        $("body > .tips").remove();
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
   初始化
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.townpicker.init = function( handler , opts ) {
        var initValueArray = $(handler).attr(opts.resultValueAttr).split(opts.separator) ;       
        var controller = opts.controller ;
        controller.request( controller.apiUrl.common.town , { "cityId" : $(opts.cityIdSelector).val() } , {
            "showLoadingTips" : true ,
            "loadingTips" : "加载中..." ,
            "successCallback" : function(data) {
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
               首先清空现有记录
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                $(".town-picker>.district").empty() ;
                $(".town-picker>.town").remove() ;
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
               再绘制全新的记录
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                var result = data.data ;
                for(var key in result) {
                    $(".town-picker>.district").append("<li data-id=\"" + key + "\">" + result[key].label + "</li>") ;
                    var $ul = $(document.createElement("UL")).addClass("town").attr( "id" , "town" + key ) ;
                    result[key].towns && result[key].towns.length && result[key].towns.forEach(function(town){
                        var $li = $(document.createElement("LI")).attr("data-id" , town.id) ;
                        if($.inArray( town.id , initValueArray ) != -1) $li.addClass("on") ;
                        $li.append("<span>" + town.label + "</span>") ;
                        var $sign = ($.inArray( town.id , initValueArray ) != -1) ? "<i class=\"iconfont icon-teseyixuan\"></i>" : "<i class=\"iconfont icon-teseweixuan\"></i>" ;
                        $li.append($sign) ;
                        $ul.append($li) ;
                    }) ;
                    $(".town-picker").append($ul) ;
                }               
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                添加区域和板块选项的事件监听
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                $.fn.townpicker.addEventListeners() ; 
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                模拟点击第一个区域
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                $(".town-picker>.district>li").eq(0).trigger("click") ;                
            },
            completeCallback: function() {
                $("body > .tips").remove();
            }
        }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
   重置
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.townpicker.reset = function() {
        $(".town-picker>.town>li.on>.iconfont").removeClass("icon-teseyixuan").addClass("icon-teseweixuan") ;
        $(".town-picker>.town>li").removeClass("on") ;        
        $(".town-picker>.district>li").eq(0).trigger("click") ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
   确定
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
     $.fn.townpicker.confirm = function( handler , opts ) {
        var labelArray = new Array ;
        var valueArray = new Array ;
        if( ! $(".town-picker>.town>li.on").size()) {
            $.tips("您还没有选择任何板块！" , 3 ) ;
            return ;
        }
        if( $(".town-picker>.town>li.on").size()>10) {
            $.tips("最多可添加10个版块，无法添加超过10个！" , 3 ) ;
            return ;
        }
        $(".town-picker>.town>li.on").each(function(){
            labelArray.push($(this).find("span").text()) ;
            valueArray.push($(this).attr("data-id")) ;
        }) ;
        var giveToback = [];
        $(".town-picker>.town").each(function() {
            var single = {
                districtId: $(this).attr("id").replace(/town/, ""),
                districtName: "",
                towns: []
            };
            $(this).children(".on").each(function(){
                var town = {
                    id: $(this).attr("data-id"),
                    label: $(this).text()
                };
                single.towns.push(town);
            })
            if(single.towns.length !==0) giveToback.push(single);
        })
        $(handler).find(opts.resultLabelContainerSelector).text(labelArray.join(",")) ;
        $(handler).attr(opts.resultValueAttr , valueArray.join(",")) ;
        $.fn.townpicker.close() ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        最后执行回调
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        opts.callback(giveToback) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     townpicker默认配置
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.townpicker.defaults = {        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        选择好的城市label以后往节点下的什么选择器表达的容器下写入
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "resultLabelContainerSelector" : "dd" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        选择好的城市value往节点的什么属性下写入
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "resultValueAttr" : "data-value" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        多个label或者value的分隔符
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "separator" : "," ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
       存放cityId的隐藏域的id
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "cityIdSelector" : "#cityId" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        controller基类，要使用它的request方法
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "controller" : null ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        点击确定后的回调
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "callback" : $.noop
    } ;
})(jQuery) ;